Name: ChaliceBuildAndDeploy
SchemaVersion: "1.0"

Triggers:
  - Type: Push
    Branches:
      - main

Actions:
  Build:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Compute:
      Type: EC2
    Configuration:
      Steps:
        - Run: |
            # Install system dependencies
            sudo yum update -y
            sudo yum install -y wget tar gzip make gcc openssl-devel bzip2-devel libffi-devel zlib-devel

            # Download and install Python 3.13
            echo "Downloading Python 3.13..."
            cd /tmp
            wget https://www.python.org/ftp/python/3.13.1/Python-3.13.1.tgz
            tar -xzf Python-3.13.1.tgz
            cd Python-3.13.1

            echo "Building Python 3.13 from source..."
            ./configure --enable-optimizations
            make -j$(nproc)
            sudo make altinstall

            # Set Python 3.13 as default
            echo "Setting Python 3.13 as the default version..."
            sudo ln -sf /usr/local/bin/python3.13 /usr/bin/python3
            sudo ln -sf /usr/local/bin/python3.13 /usr/bin/python

            echo "Verifying Python installation:"
            python --version

            # Upgrade pip and install Python dependencies
            python -m pip install --upgrade pip
            python -m pip install -r requirements.txt
            python -m pip install chalice bandit flake8 pytest coverage pytest-cov

            # Run security and lint checks
            echo "Running security check with Bandit..."
            bandit -r .

            echo "Running lint check with Flake8..."
            flake8 .

            # Execute tests with coverage
            echo "Running tests with coverage..."
            pytest --cov=.
